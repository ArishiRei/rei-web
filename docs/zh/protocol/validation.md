# 验证与质量门禁

本文档定义了 Nuxt 4 项目的质量检查清单、验证标准和完成定义 (DoD) 要求。这些验证标准确保所有代码都符合既定的 [原则](./principles.md)、[架构](./architecture.md)、[编码规范](./coding-standards.md) 和 [工作流程](./workflow.md) 要求。

## 完成定义 (DoD)

### 任务完成检查清单

在宣布任何任务完成之前，必须验证以下检查清单：

#### 代码质量门禁
- [ ] **Lint 合规性**: 代码通过 `pnpm lint` (ESLint + Stylelint) 且无错误
- [ ] **构建验证**: 代码通过 `pnpm build` (SSR 构建) 且无错误
- [ ] **静态生成**: 代码通过 `pnpm generate` (SSG) 且无错误
- [ ] **类型安全**: 所有 TypeScript 类型都是显式的，未使用 `any` 类型
- [ ] **导入组织**: 导入遵循既定顺序 (Vue → Nuxt → 第三方 → 本地)

#### 架构合规性
- [ ] **目录结构**: 文件根据 [架构标准](./architecture.md) 放置在正确的目录中
- [ ] **组件组织**: 组件遵循正确的分类 (base/domain/layout/ui)
- [ ] **依赖规则**: 导入依赖尊重层级边界 (app ↔ shared ↔ server)
- [ ] **命名规范**: 文件和组件遵循既定的命名模式
- [ ] **关注点分离**: 代码正确分离了客户端、服务端和共享逻辑

#### 功能要求
- [ ] **功能完整性**: 所有指定的功能均已实现
- [ ] **错误处理**: 为所有失败场景提供适当的错误处理
- [ ] **国际化**: 所有面向用户的文本都使用 `$t()` 进行本地化
- [ ] **无障碍 (Accessibility)**: 组件符合 WCAG 无障碍标准
- [ ] **响应式设计**: UI 在各种设备尺寸下都能正常工作

#### 文档要求
- [ ] **代码文档**: 公共 API 具有 JSDoc 注释
- [ ] **变更文档**: 在 `docs/_logs/temp.md` 中创建了开发日志
- [ ] **Wiki 更新**: 如果适用，记录了 Material Web 组件的用法
- [ ] **指南更新**: 为复杂功能更新了实现指南

#### 版本控制
- [ ] **提交标准**: 提交遵循约定式提交 (Conventional Commits) 格式
- [ ] **原子提交**: 每个提交代表一个逻辑变更
- [ ] **分支整洁**: 功能分支整洁并准备好合并
- [ ] **代码审查**: 代码已通过审查并获得批准

#### 规范演进
- [ ] **模式评估**: 评估了变更是否引入了新模式
- [ ] **协议更新**: 如果出现了新标准，更新了协议文档
- [ ] **交叉引用维护**: 更新了协议文档之间的交叉引用

## 自动化验证

### Lint 检查与代码质量

#### ESLint 验证
```bash
# 命令: pnpm lint
# 验证内容:
- TypeScript 语法与语义
- Vue 组件结构与最佳实践
- 导入/导出组织
- 命名规范合规性
- 代码复杂度与可维护性
```

**要求的 ESLint 规则**:
- `@typescript-eslint/no-explicit-any`: 禁止使用 `any` 类型
- `@typescript-eslint/explicit-function-return-type`: 要求返回类型注解
- `vue/component-name-in-template-casing`: 强制使用 PascalCase 组件名
- `import/order`: 强制执行导入排序标准

#### Stylelint 验证
```bash
# 命令: pnpm lint:style
# 验证内容:
- CSS 属性排序
- 命名规范合规性 (kebab-case)
- Design Token 使用 (无魔术值)
- 选择器优先级限制
```

**要求的 Stylelint 规则**:
- `order/properties-order`: 强制执行 CSS 属性排序
- `selector-class-pattern`: 强制执行 kebab-case 类名
- `declaration-no-important`: 禁止使用 `!important`
- `color-no-hex`: 要求使用 Design Token 而不是十六进制颜色

### 构建验证

#### TypeScript 编译
```bash
# 命令: pnpm build
# 验证内容:
- 整个代码库的类型安全
- 模块解析与导入
- SSR 兼容性
- 服务端渲染功能
```

**构建要求**:
- 零 TypeScript 编译错误
- 所有导入解析正确
- 无循环依赖
- 服务端渲染在无客户端依赖的情况下正常工作

#### 静态网站生成 (SSG)
```bash
# 命令: pnpm generate
# 验证内容:
- 所有路由的预渲染
- 静态资源优化
- SEO 元数据生成
- 性能优化
```

**生成要求**:
- 所有路由成功生成
- 预渲染期间无运行时错误
- 创建了优化的资源包
- 正确生成了 SEO 元数据

## 手动验证检查清单

### 组件开发检查清单

#### 基础组件验证
- [ ] **Material Web 封装**: 组件使用 `Rei` 前缀正确封装了 Material Web 组件
- [ ] **Props 接口**: 为所有 props 提供清晰的 TypeScript 接口
- [ ] **事件触发**: 具有类型化有效负载的正确事件触发
- [ ] **插槽使用**: 用于内容分发的适当插槽定义
- [ ] **无障碍**: 支持 ARIA 属性和键盘导航
- [ ] **主题化**: 使用 Design Token 而不是硬编码值
- [ ] **文档**: 记录了带有示例的组件用法

#### 领域组件验证
- [ ] **业务逻辑**: 包含适当的领域特定逻辑
- [ ] **基础组件使用**: 使用基础组件而不是原始 Material Web
- [ ] **状态管理**: 如果需要，与 Pinia store 正确集成
- [ ] **API 集成**: 使用 `useApi` composable 进行数据获取
- [ ] **错误处理**: 带有用户反馈的优雅错误处理
- [ ] **加载状态**: 异步操作期间具有适当的加载指示器

### API 开发检查清单

#### 服务端路由验证
- [ ] **类型安全**: 正确定义请求和响应类型
- [ ] **错误处理**: 统一的错误响应格式
- [ ] **身份验证**: 在需要时进行适当的身份验证检查
- [ ] **验证**: 使用适当的 schema 进行输入验证
- [ ] **文档**: 记录了带有示例的 API 端点
- [ ] **Mock 实现**: 在 `server/api/` 中提供开发 Mock

#### Composable 验证
- [ ] **单一职责**: Composable 具有清晰、专注的目的
- [ ] **类型安全**: 为所有参数和返回值提供正确的 TypeScript 类型
- [ ] **错误处理**: 一致的错误处理模式
- [ ] **响应性**: 正确使用 Vue 响应式系统
- [ ] **可复用性**: 可在多个组件中使用
- [ ] **测试**: 单元测试覆盖主要功能

### 功能集成检查清单

#### 全功能验证
- [ ] **端到端流程**: 完整的用户旅程按预期工作
- [ ] **跨浏览器测试**: 在主流浏览器中验证功能
- [ ] **移动端响应式**: 功能在移动设备上正常工作
- [ ] **性能**: 无明显的性能下降
- [ ] **安全**: 未引入安全漏洞
- [ ] **无障碍**: 功能对残障用户友好
- [ ] **国际化**: 所有文本均已正确本地化

## 质量指标与阈值

### 代码质量指标

#### 复杂度阈值
- **圈复杂度**: 每个函数最高 10
- **文件长度**: 每个文件最高 300 行
- **函数长度**: 每个函数最高 50 行
- **参数数量**: 每个函数最高 5 个参数

#### 测试覆盖率要求
- **单元测试覆盖率**: 至少 80% 的行覆盖率
- **集成测试覆盖率**: 必须覆盖关键路径
- **E2E 测试覆盖率**: 必须测试主要用户旅程

#### 性能阈值
- **包体积**: 主包最高 250KB
- **首次内容绘制 (FCP)**: 1.5 秒以内
- **最大内容绘制 (LCP)**: 2.5 秒以内
- **累积布局偏移 (CLS)**: 0.1 以下

### 架构合规性指标

#### 目录结构合规性
- **文件放置**: 100% 的文件位于正确的目录中
- **命名规范**: 100% 符合命名标准
- **导入依赖**: 零层级边界违反
- **组件组织**: 所有组件分类正确

#### 文档覆盖率
- **公共 API 文档**: 100% 的导出函数已记录
- **组件文档**: 所有组件均有用法示例
- **协议文档**: 标准反映了当前的实现
- **变更文档**: 记录了所有重大变更

## 验证自动化

### Pre-commit 钩子

#### 自动化检查
```bash
# Pre-commit 验证序列
1. 检查暂存文件的 Lint (ESLint + Stylelint)
2. 对修改的 TypeScript 文件进行类型检查
3. 使用 Prettier 格式化代码
4. 验证提交消息格式
5. 检查合并冲突
```

#### Git Hook 配置
```bash
# .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

pnpm lint-staged
pnpm type-check
```

### 持续集成验证 (CI Validation)

#### CI 流水线阶段
```yaml
# GitHub Actions / CI 流水线
阶段:
  - install: 安装依赖
  - lint: 运行 ESLint 和 Stylelint
  - type-check: TypeScript 编译
  - test: 运行单元测试和集成测试
  - build: 验证 SSR 构建
  - generate: 验证 SSG 生成
  - security: 安全漏洞扫描
  - performance: 性能回归测试
```

#### CI 中的质量门禁
- **Lint 门禁**: 零 lint 错误或警告
- **类型门禁**: 零 TypeScript 编译错误
- **测试门禁**: 所有测试通过，达到覆盖率阈值
- **构建门禁**: 成功构建和生成
- **安全门禁**: 无高风险或严重漏洞
- **性能门禁**: 无明显的性能回归

## 验证工具与脚本

### 自定义验证脚本

#### 项目结构验证
```typescript
// scripts/validate-structure.ts
// 验证内容:
- 目录结构合规性
- 文件命名规范
- 导入依赖规则
- 组件组织模式
```

#### 文档验证
```typescript
// scripts/validate-docs.ts
// 验证内容:
- 交叉引用完整性
- 文档完整性
- 协议同步
- 示例代码准确性
```

### 与开发工作流集成

#### IDE 集成
- **ESLint 扩展**: 实时 lint 反馈
- **TypeScript 扩展**: 类型检查与 IntelliSense
- **Prettier 扩展**: 自动代码格式化
- **Vue 扩展**: Vue 特定的验证与功能

#### 命令行工具
```bash
# 验证命令
pnpm validate:all        # 运行所有验证检查
pnpm validate:structure  # 检查项目结构
pnpm validate:docs      # 检查文档
pnpm validate:types     # 检查 TypeScript 类型
pnpm validate:deps      # 检查依赖合规性
```

## 验证报告

### 质量仪表盘
- **代码质量指标**: 复杂度、覆盖率、重复率
- **架构合规性**: 结构、命名、依赖
- **性能指标**: 包体积、加载时间、核心 Web 指标 (Core Web Vitals)
- **安全状态**: 漏洞数量与严重程度
- **文档覆盖率**: API 文档、指南、示例

### 验证报告
- **每日报告**: 自动化质量指标报告
- **PR 报告**: 拉取请求的验证状态
- **发布报告**: 发布的全面质量评估
- **趋势分析**: 随时间变化的质量指标

---

*这些验证标准确保所有代码都符合既定的质量要求，并与项目的 [核心原则](./principles.md) 和 [开发标准](./coding-standards.md) 保持一致。*
